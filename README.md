# Lifegoals

![coverage][coverage_badge]
[![style: very good analysis][very_good_analysis_badge]][very_good_analysis_link]
[![License: MIT][license_badge]][license_link]

Generated by the [Very Good CLI][very_good_cli_link] ü§ñ

Flutter lifegoals app

---

# Reflections

- VGV Cli creates with Github good development environment really fast
- Bloc seems to me easy to use and especially test
- I hope Freezed helps to save some boilerplate code from Blocs events and states
- Go router seems to be solid choice - easy api, well documented - only 100% code coverage is challenging
- I thought to use firebase auth ui, but are now uncertain if it makes sense to broke modularization of architecture just for it
- Firebase auth UI ties you to single cloud provider, and changing it later would be harder than necessary
- Decision to use or not to use Firebase Auth ui boils down to question if one wants to invest on cloud independent solution

## How to repeat creating this app

NOTE: There's currently only needed configs for "production" flavor. Running others flavors might fail.

#### Install very good cli

https://github.com/VeryGoodOpenSource/very_good_cli

```sh
# install very good cli
$ dart pub global activate very_good_cli
```

#### Create app with very good core as base

https://github.com/VeryGoodOpenSource/very_good_core

```sh
# create app with very good cli
$ very_good create lifegoals --desc ‚ÄúFlutter lifegoals app" --org ‚Äúfi.nikkijuk.lifegoals‚Äù
```

#### Configure firebase

- https://firebase.google.com/codelabs/firebase-get-to-know-flutter#2

Create account to https://firebase.google.com/

Go to Firebase console https://console.firebase.google.com/

Create firebase instance 'lifegoals'

#### install firebase cli

- https://github.com/firebase/firebase-tools

```sh
# use brew (osx) to install firebase cli
$ brew install firebase-cli
```

#### Login and Check firebase project

```sh
# login to firebase
$ firebase login

# list all projects
$ firebase projects:list
```

#### Install firebase dependencies

make sure that you are at project directory

```sh
# core
$ flutter pub add firebase_core

# authentication
$ flutter pub add firebase_auth

# authentication ui components
$ flutter pub add firebase_ui_auth

# firestore
$ flutter pub add cloud_firestore
```

Note: You might need to go to Android studio and update dependency versions manually due to incompatibility of dependencies.

#### fix problem with api levels

open android/app/build.gradle

change min sdk level to be 21 

```
    defaultConfig {
        // TODO: Specify your own unique Application ID (https://developer.android.com/studio/build/application-id.html).
        applicationId "fi.nikkijuk.lifegoals.lifegoals"
        minSdkVersion 21 // flutter.minSdkVersion
        targetSdkVersion flutter.targetSdkVersion
        versionCode flutterVersionCode.toInteger()
        versionName flutterVersionName
    }
```

NOTE: I don't know if 21 is correct version, but after this change we get forward

NOTE: You might not want to hardcode your minsdk version as it's done here.

#### create firebase configuration

this step creates *firebase_options.dart* and modifies some existing files

```sh
# create configuration files 
$ flutterfire configure
```

#### Take care of api keys

Generated / modified files contain api keys, which you might not want to commit to git.

- https://firebase.google.com/docs/projects/api-keys

See: iOS/Runner/GoogleService-Info.plist

```
	<key>API_KEY</key>
	<string><secret_you_might_not_want_to_compromize></string>
```

NOTE: It's ok'ish to share api key for firebase if your firebase security definitions are properly done. Pay attention to details.

####  Format generated firebase config

```sh
# format all files according to dart rules
$ flutter format .  
```

Note: there's some rule ignores present, but they might not be all applied 

#### Fix analyse errors in generated firebase config

```sh
# check if we have problems
$ flutter analyze lib test
```

modify generated firebase_options.dart

as it doesn't compile, and it's generated, make minimal changes to get forward.. 

- disable rule: *no_default_cases*

```
// File generated by FlutterFire CLI.
// ignore_for_file: lines_longer_than_80_chars, avoid_classes_with_only_static_members, no_default_cases
```

generated files might be regenerated later, so you don't want to make them perfect

#### Add router

- https://pub.dev/packages/go_router

```sh
# check if we have problems
$ flutter pub add go_router
```

#### make separate class to routes and router rules

lib/core/navigation.dart

#### Import go router

```
    import 'package:go_router/go_router.dart';
```

#### Add route config

- https://pub.dev/documentation/go_router/latest/topics/Get%20started-topic.html

Define routes

```
class Routes {
  static const home = '/';
}
```

Create function to build router

```
GoRouter router() => GoRouter(
      routes: [
        GoRoute(
          path: Routes.home,
          builder: (_, __) => const CounterPage(),
        )
      ],
    );
```

#### take router config in use

use router constructor https://api.flutter.dev/flutter/material/MaterialApp/MaterialApp.router.html

lib/app/view/app.dart

```
    return MaterialApp.router(
      theme: ThemeData(
        appBarTheme: const AppBarTheme(color: Color(0xFF13B9FF)),
        colorScheme: ColorScheme.fromSwatch(
          accentColor: const Color(0xFF13B9FF),
        ),
      ),
      localizationsDelegates: AppLocalizations.localizationsDelegates,
      supportedLocales: AppLocalizations.supportedLocales,
      routerConfig: router(),
    );
```

#### add about page

define new route
- add "about" route 
- add router configuration which points to about page

add counter page button to navigate using new route
- add "i" icon to counter page to navigate to about page with context.go (Routes.about)

create about page component
- add navigation back to counter
- add localizations

#### fix hero tag errors

- https://api.flutter.dev/flutter/material/FloatingActionButton/heroTag.html

added hero tags while there's more than one action button in tree

#### fix 100% code coverage problem

Adding about page was ok, but test code coverage might have dropped

#### install lcov

get tools

```sh
# install lcov (osx)
$ brew install lcov
```

#### check coverage

all but 100% fail at github

```sh
# collect code coverage
$ flutter test --coverage --test-randomize-ordering-seed randomgenhtml coverage/lcov.info -o coverage/

# check if we have problems
$ genhtml coverage/lcov.info -o coverage/
```

#### Rats! Navigation needs to be tested

There isn't ready testing libraries for go router, so we need to do own helpers

Look ideas from here

- https://guillaume.bernos.dev/testing-go-router/
- https://guillaume.bernos.dev/testing-go-router-2/

#### Add mocking for router

https://pub.dev/packages/mocktail

```sh
# add mocking lib
$ flutter pub add mocktail
```

Define mocked router and provider for mocked router

```
class MockGoRouter extends Mock implements GoRouter {}

class MockGoRouterProvider extends StatelessWidget {
  const MockGoRouterProvider({
    required this.goRouter,
    required this.child,
    super.key,
  });

  /// The mock navigator used to mock navigation calls.
  final MockGoRouter goRouter;

  /// The child [Widget] to render.
  final Widget child;

  @override
  Widget build(BuildContext context) => InheritedGoRouter(
        goRouter: goRouter,
        child: child,
      );
}
```

#### Write addition test helpers

test/helpers/pump_app.dart

one helper method for mocked routes

```
extension PumpMockRouterApp on WidgetTester {
  Future<void> pumpMockRouterApp(Widget widget, MockGoRouter mockGoRouter) {
    return pumpWidget(
      MaterialApp(
        localizationsDelegates: AppLocalizations.localizationsDelegates,
        supportedLocales: AppLocalizations.supportedLocales,
        home: MockGoRouterProvider(goRouter: mockGoRouter, child: widget),
      ),
    );
  }
}
```

one helper method without mocking for app startup

```
extension PumpRealRouterApp on WidgetTester {
  Future<void> pumpRealRouterApp(GoRouter router) {
    return pumpWidget(
      MaterialApp.router(
        localizationsDelegates: AppLocalizations.localizationsDelegates,
        supportedLocales: AppLocalizations.supportedLocales,
        routeInformationParser: router.routeInformationParser,
        routerDelegate: router.routerDelegate,
      ),
    );
  }
}
```

NOTE: If there is persistent state which needs to be filled in state management 
and changes routing rules this logic will become later more complicated 
or test will need to do setup before building app.

NOTE: Might not work with deep linking currently. Not tested as web is not primary target.

#### Write test for default root (/)

```
    testWidgets('renders CounterPage via Router as home screen',
        (tester) async {
      await tester.pumpRealRouterApp(router());
      expect(find.byType(CounterView), findsOneWidget);
      expect(find.byType(BackButton), findsNothing);
    });
```

Note: This test should select "/" route as default.

#### Write tests which use mocked router

```
    testWidgets('is redirected when button is tapped', (tester) async {
      final mockGoRouter = MockGoRouter();

      await tester.pumpMockRouterApp(const CounterPage(), mockGoRouter);

      await tester.tap(find.byIcon(Icons.info));
      await tester.pumpAndSettle();

      verify(() => mockGoRouter.go(Routes.about)).called(1);
      verifyNever(() => mockGoRouter.go(Routes.home));
    });
  });
```

#### Set ignores when nothing else helps

Read docs https://pub.dev/packages/coverage

- Use *// coverage:ignore-line* to ignore one line. 
- Use *// coverage:ignore-start* and *// coverage:ignore-end* to ignore range of lines inclusive. 
- Use *// coverage:ignore-file* to ignore the whole file.

NOTE: this is needed as route builders are not used while testing - they are mocked, so: never called.

## Flavors üöÄ

This project contains 3 flavors:

- development
- staging
- production

To run the desired flavor either use the launch configuration in VSCode/Android Studio or use the following commands:

```sh
# Development
$ flutter run --flavor development --target lib/main_development.dart

# Staging
$ flutter run --flavor staging --target lib/main_staging.dart

# Production
$ flutter run --flavor production --target lib/main_production.dart
```

_\*Lifegoals works on iOS, Android, Web, and Windows._

---

## Running Tests üß™

To run all unit and widget tests use the following command:

```sh
$ flutter test --coverage --test-randomize-ordering-seed random
```

To view the generated coverage report you can use [lcov](https://github.com/linux-test-project/lcov).

```sh
# Generate Coverage Report
$ genhtml coverage/lcov.info -o coverage/

# Open Coverage Report
$ open coverage/index.html
```

---

## Working with Translations üåê

This project relies on [flutter_localizations][flutter_localizations_link] and follows the [official internationalization guide for Flutter][internationalization_link].

### Adding Strings

1. To add a new localizable string, open the `app_en.arb` file at `lib/l10n/arb/app_en.arb`.

```arb
{
    "@@locale": "en",
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    }
}
```

2. Then add a new key/value and description

```arb
{
    "@@locale": "en",
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    },
    "helloWorld": "Hello World",
    "@helloWorld": {
        "description": "Hello World Text"
    }
}
```

3. Use the new string

```dart
import 'package:lifegoals/l10n/l10n.dart';

@override
Widget build(BuildContext context) {
  final l10n = context.l10n;
  return Text(l10n.helloWorld);
}
```

### Adding Supported Locales

Update the `CFBundleLocalizations` array in the `Info.plist` at `ios/Runner/Info.plist` to include the new locale.

```xml
    ...

    <key>CFBundleLocalizations</key>
	<array>
		<string>en</string>
		<string>es</string>
	</array>

    ...
```

### Adding Translations

1. For each supported locale, add a new ARB file in `lib/l10n/arb`.

```
‚îú‚îÄ‚îÄ l10n
‚îÇ   ‚îú‚îÄ‚îÄ arb
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app_en.arb
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app_es.arb
```

2. Add the translated strings to each `.arb` file:

`app_en.arb`

```arb
{
    "@@locale": "en",
    "counterAppBarTitle": "Counter",
    "@counterAppBarTitle": {
        "description": "Text shown in the AppBar of the Counter Page"
    }
}
```

`app_es.arb`

```arb
{
    "@@locale": "es",
    "counterAppBarTitle": "Contador",
    "@counterAppBarTitle": {
        "description": "Texto mostrado en la AppBar de la p√°gina del contador"
    }
}
```

[coverage_badge]: coverage_badge.svg
[flutter_localizations_link]: https://api.flutter.dev/flutter/flutter_localizations/flutter_localizations-library.html
[internationalization_link]: https://flutter.dev/docs/development/accessibility-and-localization/internationalization
[license_badge]: https://img.shields.io/badge/license-MIT-blue.svg
[license_link]: https://opensource.org/licenses/MIT
[very_good_analysis_badge]: https://img.shields.io/badge/style-very_good_analysis-B22C89.svg
[very_good_analysis_link]: https://pub.dev/packages/very_good_analysis
[very_good_cli_link]: https://github.com/VeryGoodOpenSource/very_good_cli
